<!doctype html><html lang=en><head><meta http-equiv=refresh content="0; url=https://forge.rust-lang.org/compiler/index.html"></head><body><input type=checkbox style=display:none id=menu-control><main class="flex container"><aside class="book-menu fixed"><nav><h2 class=book-brand><a href=https://rust-lang.github.io/compiler-team/>Rust Lang - Compiler Team</a></h2><style>nav ul a[href$=\2f compiler-team\2fminutes\2f design-meeting\2f 2019-06-21-the-gcx-tcx-transition\2f ]{color:#004ed0}</style><ul><li><p><strong>About</strong></p><ul><li><a href=/compiler-team/about/CODE_OF_CONDUCT/>Code of Conduct</a></li><li><a href=/compiler-team/about/chat-platform/>Chat Platform</a></li><li><a href=/compiler-team/about/steering-meeting/>Steering Meeting</a></li><li><a href=/compiler-team/about/triage-meeting/>Triage Meeting</a></li></ul></li><li><p><strong>Minutes</strong></p><ul><li><a href=/compiler-team/minutes/design-meeting/>Design Meetings</a></li><li><a href=/compiler-team/minutes/steering-meeting/>Steering Meetings</a></li><li><a href=/compiler-team/minutes/triage-meeting/>Triage Meetings</a></li></ul></li><li><p><strong>Procedures</strong></p><ul><li><a href=/compiler-team/procedures/>Documentation</a></li><li><a href=/compiler-team/procedures/crates/>Crates</a></li><li><a href=/compiler-team/procedures/call-for-participation/>Call for participation</a></li><li><a href=/compiler-team/procedures/form-new-working-group/>Form new working group</a></li></ul></li><li><p><a href=/compiler-team/working-groups/><strong>Working Groups</strong></a></p><ul><li><a href=/compiler-team/working-groups/async-await/>Async Await</a></li><li><a href=/compiler-team/working-groups/debugging/>Debugging</a></li><li><a href=/compiler-team/working-groups/diagnostics/>Diagnostics</a></li><li><a href=/compiler-team/working-groups/rustc-dev-guide/>Rustc Dev Guide</a></li><li><a href=/compiler-team/working-groups/llvm/>LLVM</a></li><li><a href=/compiler-team/working-groups/meta/>Meta</a></li><li><a href=/compiler-team/working-groups/mir-opt/>MIR-opt</a></li><li><a href=/compiler-team/working-groups/nll/>NLL</a></li><li><a href=/compiler-team/working-groups/parallel-rustc/>parallel rustc</a></li><li><a href=/compiler-team/working-groups/pgo/>PGO</a></li><li><a href=/compiler-team/working-groups/pipelining/>pipelining</a></li><li><a href=/compiler-team/working-groups/polonius/>polonius</a></li><li><a href=/compiler-team/working-groups/polymorphization/>polymorphization</a></li><li><a href=/compiler-team/working-groups/prioritization/>Prioritization</a></li><li><a href=/compiler-team/working-groups/rfc-2229/>rfc-2229</a></li><li><a href=/compiler-team/working-groups/rls-2.0/>rls-2.0</a></li><li><a href=/compiler-team/working-groups/self-profile/>Self Profile</a></li><li><a href=/compiler-team/working-groups/traits/>Traits</a></li></ul></li></ul></nav></aside><div class=book-page><header class="align-center justify-between book-header"><label for=menu-control><img src=/compiler-team/svg/menu.svg alt=Menu>
</label><strong>Planning the gcx, tcx transition</strong></header><article class=markdown><h1 id=planning-the-gcx-tcx-transition>Planning the <code>'gcx, 'tcx</code> transition</h1><ul><li><a href=https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/design.20meeting.202019.2E06.2E14>Zulip thread</a></li></ul><h1 id=summary>Summary</h1><ul><li>Discuss the end-state for <code>tcx</code></li><li>Plan the steps we will take to get there and time frame</li></ul><h1 id=motivation>Motivation</h1><p>Now that we have removed the per-inference context interners, we plan to transition the compiler to a different naming scheme. This is a major shift and something we should plan carefully.</p><p>Also, it&rsquo;s an opportunity to consider an alternate naming scheme &ndash; <code>tcx</code> and <code>'tcx</code> is not known to be particularly popular.</p><h1 id=details>Details</h1><h2 id=names-for-tcx>Names for tcx</h2><ul><li>Given the new, query-focused compiler design, there have been proposals to rename tcx to something like <code>QueryCx</code>. The lifetime name <code>'tcx</code> is also not particularly evocative.<ul><li>One obvious proposal would be <code>qcx</code> and <code>'qcx</code> though this is not obviously better.</li><li><code>q: QueryContext&lt;'query></code> or something like that is also viable though longer</li><li>(eddyb) <code>qx: QueryCx&lt;'q></code> (if we want to make it about queries)</li><li><code>db: RustcDb&lt;'db></code> (if we want to go the salsa route)</li></ul></li></ul><h2 id=transition-plan>Transition plan</h2><p>eddyb has a plan I sort of understand:</p><ul><li><del>transition <code>TyCtxt&lt;'_, 'tcx, 'tcx></code>-using code first, to <code>TyCx&lt;'tcx></code> (name doesn&rsquo;t matter as long as it&rsquo;s unique for easy replacement later)</del></li><li><del>then start moving <code>'gcx,'tcx</code> code one InferCtxt user at a time, by making InferCtxt creation allow both <code>'tcx,'tcx</code> and <code>'gcx,'tcx</code></del></li><li><strong>UPDATE</strong>: brute force was easier: <a href=https://github.com/rust-lang/rust/pull/61817>https://github.com/rust-lang/rust/pull/61817</a> (see PR description for how it was done)</li><li>what&rsquo;s left to discuss is whether we want this solution</li></ul><p>There are some question marks around timing:</p><ul><li>What will it be like to rebase a major PR over these changes?</li><li>Any major PRs outstanding we want to block on?</li></ul><h1 id=challenges>Challenges</h1><ul><li>Bikeshed :)</li></ul><h1 id=key-design-questions>Key design questions</h1><p>Unclear</p><h1 id=notes-from-meeting>Notes from meeting</h1><ul><li>PRs thus far:<ul><li>ban unused lifetimes: <a href=https://github.com/rust-lang/rust/pull/61722>#61735</a></li><li>remove the <code>'a</code> <a href=https://github.com/rust-lang/rust/pull/61722>#61722</a></li><li>centralize to <code>TyCtxt&lt;'tcx></code> <a href=https://github.com/rust-lang/rust/pull/61817>#61817</a></li></ul></li><li>Create <a href=https://github.com/rust-lang/rust/issues/61838>#61838</a> to serve as a tracking issue</li><li>So, to make the transition:<ul><li>generally rewrite <code>TyCtxt&lt;..></code> to <code>TyCtxt&lt;'tcx></code> or <code>TyCtxt&lt;'_></code></li><li>typically, rewrite <code>TyCtxt&lt;'_, '_, 'tcx></code> to <code>TyCtxt&lt;'tcx></code><ul><li>note that if you have <code>TyCtxt&lt;'_, 'tcx, '_></code>, rewrite to <code>TyCtxt&lt;'tcx></code></li></ul></li><li>replace unused lifetimes with <code>'_</code>, typically</li><li>note: when adapting your code, you should never need to introduce a new lifetime, you&rsquo;re only removing them<ul><li>if you find yourself adding a <code>'gcx</code> to some impl, that&rsquo;s wrong =)</li></ul></li></ul></li><li>Possible future naming:<ul><li>We are not thrilled with <code>TyCtxt&lt;'tcx></code> and are considering some alternatives:<ul><li><code>qx: QueryCx&lt;'q></code><ul><li>couple with <code>x</code> being the suffix we use for &ldquo;contexts&rdquo; in general (this convention was adopted in trans, but not elsewhere)</li></ul></li><li><code>db: RustcDb&lt;'db></code> (or perhaps <code>db: Database&lt;'db></code>)<ul><li>used in salsa, it&rsquo;s the central storage for compiler state; but there are concerns that db doesn&rsquo;t fit &ldquo;computation&rdquo;</li><li>if we do more modules, then <code>RustcDb</code> might also be <code>ParsingDb</code> (for parsing-related queries), <code>TypeckDb</code> (for type-related queries), etc</li><li>though there are some impl concerns around that; salsa style modules do impose<ul><li>dyn dispatch for each call, even cache hits; or,</li><li>monomorphization costs</li></ul></li></ul></li><li><code>rs: Rust&lt;'rs></code></li><li><code>rx: Rust&lt;'rx></code><ul><li>this is the &ldquo;rust compiler&rdquo;, so maybe that should be the basis of the name?</li></ul></li><li><code>s: Session&lt;'s></code><ul><li>related to existing <code>tcx.sess</code></li><li>session of &ldquo;what&rdquo;?</li></ul></li></ul></li><li>Reasoning to change:<ul><li>tcx is sort of cryptic, can we find a name that gives people a better intuition?</li><li>the name &ldquo;tcx&rdquo; suggests &ldquo;type context&rdquo;, but this context is far more general and is used in parts of the compiler (e.g., parsing, macros) that have nothing to do with types</li></ul></li></ul></li><li>Conclusion on naming:<ul><li>let&rsquo;s let it sit for a bit, not high priority</li></ul></li></ul></article></div><aside class="book-toc level-6 fixed"><nav id=TableOfContents><ul><li><a href=#names-for-tcx>Names for tcx</a></li><li><a href=#transition-plan>Transition plan</a></li></ul></nav></aside></main></body></html>