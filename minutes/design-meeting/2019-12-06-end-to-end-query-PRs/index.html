<!doctype html><html lang=en><head><meta http-equiv=refresh content="0; url=https://forge.rust-lang.org/compiler/index.html"></head><body><input type=checkbox style=display:none id=menu-control><main class="flex container"><aside class="book-menu fixed"><nav><h2 class=book-brand><a href=https://rust-lang.github.io/compiler-team/>Rust Lang - Compiler Team</a></h2><style>nav ul a[href$=\2f compiler-team\2fminutes\2f design-meeting\2f 2019-12-06-end-to-end-query-PRs\2f ]{color:#004ed0}</style><ul><li><p><strong>About</strong></p><ul><li><a href=/compiler-team/about/CODE_OF_CONDUCT/>Code of Conduct</a></li><li><a href=/compiler-team/about/chat-platform/>Chat Platform</a></li><li><a href=/compiler-team/about/steering-meeting/>Steering Meeting</a></li><li><a href=/compiler-team/about/triage-meeting/>Triage Meeting</a></li></ul></li><li><p><strong>Minutes</strong></p><ul><li><a href=/compiler-team/minutes/design-meeting/>Design Meetings</a></li><li><a href=/compiler-team/minutes/steering-meeting/>Steering Meetings</a></li><li><a href=/compiler-team/minutes/triage-meeting/>Triage Meetings</a></li></ul></li><li><p><strong>Procedures</strong></p><ul><li><a href=/compiler-team/procedures/>Documentation</a></li><li><a href=/compiler-team/procedures/crates/>Crates</a></li><li><a href=/compiler-team/procedures/call-for-participation/>Call for participation</a></li><li><a href=/compiler-team/procedures/form-new-working-group/>Form new working group</a></li></ul></li><li><p><a href=/compiler-team/working-groups/><strong>Working Groups</strong></a></p><ul><li><a href=/compiler-team/working-groups/async-await/>Async Await</a></li><li><a href=/compiler-team/working-groups/debugging/>Debugging</a></li><li><a href=/compiler-team/working-groups/diagnostics/>Diagnostics</a></li><li><a href=/compiler-team/working-groups/rustc-dev-guide/>Rustc Dev Guide</a></li><li><a href=/compiler-team/working-groups/llvm/>LLVM</a></li><li><a href=/compiler-team/working-groups/meta/>Meta</a></li><li><a href=/compiler-team/working-groups/mir-opt/>MIR-opt</a></li><li><a href=/compiler-team/working-groups/nll/>NLL</a></li><li><a href=/compiler-team/working-groups/parallel-rustc/>parallel rustc</a></li><li><a href=/compiler-team/working-groups/pgo/>PGO</a></li><li><a href=/compiler-team/working-groups/pipelining/>pipelining</a></li><li><a href=/compiler-team/working-groups/polonius/>polonius</a></li><li><a href=/compiler-team/working-groups/polymorphization/>polymorphization</a></li><li><a href=/compiler-team/working-groups/prioritization/>Prioritization</a></li><li><a href=/compiler-team/working-groups/rfc-2229/>rfc-2229</a></li><li><a href=/compiler-team/working-groups/rls-2.0/>rls-2.0</a></li><li><a href=/compiler-team/working-groups/self-profile/>Self Profile</a></li><li><a href=/compiler-team/working-groups/traits/>Traits</a></li></ul></li></ul></nav></aside><div class=book-page><header class="align-center justify-between book-header"><label for=menu-control><img src=/compiler-team/svg/menu.svg alt=Menu>
</label><strong>2019-12-06 end-to-end query PRs</strong></header><article class=markdown><h1 id=design-meeting-2019-12-06----librustc_interface-queries>Design Meeting 2019-12-06 &ndash; librustc_interface queries</h1><h2 id=links>Links</h2><ul><li><a href=https://zulip-archive.rust-lang.org/131828tcompiler/75795designmeeting20191206.html>Zulip topic of the discussion</a></li><li><a href=https://github.com/rust-lang/compiler-team/issues/175>Compiler team issue</a></li><li><a href=https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/pre-design.20meeting.202019-12-05>Pre-design meeting Zulip topic</a></li><li><a href=https://internals.rust-lang.org/t/migrating-rustc-interface-queries-to-proper-librustc-queries/10433>Internals thread</a> with descriptions of PRs</li></ul><h2 id=background>Background</h2><ul><li>Goal is <strong>end-to-end queries</strong><ul><li>Benefits: Simpler overall model</li><li>Incremental extending back to parsing<ul><li>mw has done measurements suggesting that on larger crates some 40% of the compilation time comes from</li></ul></li><li>Parallel compilation would be more effective, if done on the basis of queries</li></ul></li><li>Agenda<ul><li>Tough to frame:)</li><li>Most important question to settle is what overall stategy we plan to take<ul><li>Do we want to try and land / rebase these PRs?</li><li>Try a different tack?</li><li>Hold off and let other things progess?</li></ul></li></ul></li></ul><h2 id=commentary-on-the-meeting>Commentary on the meeting</h2><p>This is written after the fact, and is an attempt by nikomatsakis to capture some of the key considerations.</p><ul><li>The PRs were written with the goal of moving rust immediately to an end-to-end query system<ul><li>the queries that get created here are not, however, as clean as one might expect</li><li>as an example, instead of creating fine-grained queries for handling HIR, we would create a single HIR Map query and retain today&rsquo;s special case code that tries to track which bits of the data the methods on the HIR map access</li></ul></li><li>An alternative approach would be to move more slowly but work more on the actual design of each piece<ul><li>We might start with the HIR, decide on the actual representation that we want, and refactor into that</li><li>And then move backwards to name resolution</li><li>This overlaps somewhat with rust-analyzer, which has been built &ldquo;from the ground up&rdquo; with queries in mind, and thus has been figuring out some of what is needed here</li></ul></li><li>For context, there are definitely benefits from changing the line around the &ldquo;set of things captured in the query system&rdquo;<ul><li>e.g. big parts of the webrender-check compilation takes place before incremental even starts</li></ul></li><li>The concerns with the PRs are that<ul><li>we are kind of creating more tech debt before we start to pay it off<ul><li>since the designs are not the designs that we ultimately want</li></ul></li><li>there isn&rsquo;t really a precise enough consensus around the end state that we want<ul><li>and thus trying to move incrementally means we are kind of ambling without a clear goal</li><li>and likely to wind up with something incoherent</li></ul></li><li>the PRs introduce more special cases into the query system, not fewer</li></ul></li><li>On the other hand<ul><li>moving quickly to create queries might unlock other improvements, help us eliminate shared state</li><li>maybe you see this as an &ldquo;obvious first step whatever we do&rdquo;, in which case there isn&rsquo;t a lot of room to block<ul><li>counterargument is that these PRs are each quite complex and take a lot of reviewing load to manage etc</li></ul></li></ul></li><li>We discussed a fair amount what a desirable design for HIR might look like, <a href=https://zulip-archive.rust-lang.org/131828tcompiler/75795designmeeting20191206.html#182771577>starting around here</a><ul><li>it seemed like there was general consensus around a &ldquo;vague sketch&rdquo; where you had <code>tcx.hir(def_id)</code> give you back some kind of <code>ItemData</code> that contained the data for a particular item<ul><li>no &lsquo;special cases&rsquo; needed in the query system</li></ul></li></ul></li><li><a href=https://zulip-archive.rust-lang.org/131828tcompiler/75795designmeeting20191206.html#182772402>Alternative proposal</a><ul><li>close the PRs</li><li>encourage creation of a WG to work out a design for HIR, HIR-ID and the like and bring that design forward</li><li>land new PRs working in that direction</li><li>this overlaps heavily with rust-analyzer and could even take place in that context</li></ul></li><li>Towards the end, some topics were raised that were not fleshed out<ul><li>such as whether a <code>DefId</code> could be a &ldquo;interned&rdquo; DefPath (or whether it already is)</li><li>the need for &lsquo;queries that depend on queries&rsquo; and what that means</li></ul></li></ul></article></div><aside class="book-toc level-6 fixed"><nav id=TableOfContents><ul><li><a href=#links>Links</a></li><li><a href=#background>Background</a></li><li><a href=#commentary-on-the-meeting>Commentary on the meeting</a></li></ul></nav></aside></main></body></html>